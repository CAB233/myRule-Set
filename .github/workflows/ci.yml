name: CI
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: "45 11 * * *"
jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Download Previous Build
        uses: actions/checkout@v4
        with:
          repository: SukkaLab/ruleset.skk.moe
          path: previous-build-${{ github.run_id }}-${{ github.run_number }}
      - name: Grab Building Folder
        id: ramdisk
        run: |
          echo "build_dir=previous-build-${{ github.run_id }}-${{ github.run_number }}/sing-box" >> $GITHUB_OUTPUT
      - name: Remove upstream's custom rule
        run: |
          rm -v ${{ steps.ramdisk.outputs.build_dir }}/non_ip/my*.json
      - name: Append my custom rule
        run: |
          cp -rv source/* ${{ steps.ramdisk.outputs.build_dir }}
      - name: Custom patching
        run: |
          apt install -y sponge
          bash custom/patch.sh
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ github.sha }}-${{ github.run_number }}
          path: ${{ steps.ramdisk.outputs.build_dir }}/sing-box
          if-no-files-found: error
          retention-days: 1
          compression-level: 4
          include-hidden-files: false
  upload_to_cloudflare_r2:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact-${{ github.sha }}-${{ github.run_number }}
          path: public
      - name: Install sing-box
        run: |
          bash <(curl -fsSL https://sing-box.app/deb-install.sh)
      - name: Compile json to rule-set
        run: |
          for json in public/domainset/*.json public/ip/*.json public/non_ip/*.json; do
            echo "Compile rule-set: $json"
            sing-box rule-set compile "$json"
          done
      - uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: public
          destination-dir: ruleset
          keep-file-fresh: true
